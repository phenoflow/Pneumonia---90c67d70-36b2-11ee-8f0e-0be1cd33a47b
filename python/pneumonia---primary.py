# Eleanor L Axson, Jennifer K Quint, 2023.

import sys, csv, re

codes = [{"code":"1033111000000104","system":"snomedct"},{"code":"111900000","system":"snomedct"},{"code":"191727003","system":"snomedct"},{"code":"195878008","system":"snomedct"},{"code":"195881003","system":"snomedct"},{"code":"195886008","system":"snomedct"},{"code":"195888009","system":"snomedct"},{"code":"195889001","system":"snomedct"},{"code":"195896004","system":"snomedct"},{"code":"195900001","system":"snomedct"},{"code":"195908008","system":"snomedct"},{"code":"195911009","system":"snomedct"},{"code":"196112005","system":"snomedct"},{"code":"205237003","system":"snomedct"},{"code":"22754005","system":"snomedct"},{"code":"233606009","system":"snomedct"},{"code":"233609002","system":"snomedct"},{"code":"233624006","system":"snomedct"},{"code":"2523007","system":"snomedct"},{"code":"266350000","system":"snomedct"},{"code":"278516003","system":"snomedct"},{"code":"300999006","system":"snomedct"},{"code":"301000005","system":"snomedct"},{"code":"301001009","system":"snomedct"},{"code":"301002002","system":"snomedct"},{"code":"301003007","system":"snomedct"},{"code":"301004001","system":"snomedct"},{"code":"312342009","system":"snomedct"},{"code":"314978007","system":"snomedct"},{"code":"34020007","system":"snomedct"},{"code":"385093006","system":"snomedct"},{"code":"396285007","system":"snomedct"},{"code":"406595002","system":"snomedct"},{"code":"40733004","system":"snomedct"},{"code":"41207000","system":"snomedct"},{"code":"41269000","system":"snomedct"},{"code":"41381004","system":"snomedct"},{"code":"415125002","system":"snomedct"},{"code":"425464007","system":"snomedct"},{"code":"425996009","system":"snomedct"},{"code":"426696003","system":"snomedct"},{"code":"440990006","system":"snomedct"},{"code":"46970008","system":"snomedct"},{"code":"51530003","system":"snomedct"},{"code":"53084003","system":"snomedct"},{"code":"540151000000108","system":"snomedct"},{"code":"59475000","system":"snomedct"},{"code":"64479007","system":"snomedct"},{"code":"64667001","system":"snomedct"},{"code":"64917006","system":"snomedct"},{"code":"689401000000108","system":"snomedct"},{"code":"70036007","system":"snomedct"},{"code":"7548000","system":"snomedct"},{"code":"75570004","system":"snomedct"},{"code":"80003002","system":"snomedct"},{"code":"87628006","system":"snomedct"},{"code":"95436008","system":"snomedct"},{"code":"9861002","system":"snomedct"},{"code":"1033111000000104","system":"snomedct"},{"code":"111900000","system":"snomedct"},{"code":"191727003","system":"snomedct"},{"code":"195878008","system":"snomedct"},{"code":"195881003","system":"snomedct"},{"code":"195886008","system":"snomedct"},{"code":"195888009","system":"snomedct"},{"code":"195889001","system":"snomedct"},{"code":"195896004","system":"snomedct"},{"code":"195900001","system":"snomedct"},{"code":"195908008","system":"snomedct"},{"code":"195911009","system":"snomedct"},{"code":"196112005","system":"snomedct"},{"code":"205237003","system":"snomedct"},{"code":"22754005","system":"snomedct"},{"code":"233606009","system":"snomedct"},{"code":"233609002","system":"snomedct"},{"code":"233624006","system":"snomedct"},{"code":"2523007","system":"snomedct"},{"code":"266350000","system":"snomedct"},{"code":"278516003","system":"snomedct"},{"code":"300999006","system":"snomedct"},{"code":"301000005","system":"snomedct"},{"code":"301001009","system":"snomedct"},{"code":"301002002","system":"snomedct"},{"code":"301003007","system":"snomedct"},{"code":"301004001","system":"snomedct"},{"code":"312342009","system":"snomedct"},{"code":"314978007","system":"snomedct"},{"code":"34020007","system":"snomedct"},{"code":"385093006","system":"snomedct"},{"code":"396285007","system":"snomedct"},{"code":"406595002","system":"snomedct"},{"code":"40733004","system":"snomedct"},{"code":"41207000","system":"snomedct"},{"code":"41269000","system":"snomedct"},{"code":"41381004","system":"snomedct"},{"code":"415125002","system":"snomedct"},{"code":"425464007","system":"snomedct"},{"code":"425996009","system":"snomedct"},{"code":"426696003","system":"snomedct"},{"code":"440990006","system":"snomedct"},{"code":"46970008","system":"snomedct"},{"code":"51530003","system":"snomedct"},{"code":"53084003","system":"snomedct"},{"code":"540151000000108","system":"snomedct"},{"code":"59475000","system":"snomedct"},{"code":"64479007","system":"snomedct"},{"code":"64667001","system":"snomedct"},{"code":"64917006","system":"snomedct"},{"code":"689401000000108","system":"snomedct"},{"code":"70036007","system":"snomedct"},{"code":"7548000","system":"snomedct"},{"code":"75570004","system":"snomedct"},{"code":"80003002","system":"snomedct"},{"code":"87628006","system":"snomedct"},{"code":"95436008","system":"snomedct"},{"code":"9861002","system":"snomedct"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('pneumonia-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["pneumonia---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["pneumonia---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["pneumonia---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
